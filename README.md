
<entry>
<title>Preventing XSS attacks when embedding JSON in HTML</title>
<link href="http://sophiebits.com/2012/08/03/preventing-xss-json.html"/>
<updated>2012-08-03T00:00:00-07:00</updated>
<id>http://sophiebits.com/2012/08/03/preventing-xss-json</id>
<content type="html"><p>At Khan Academy, we recently took the time to go through our 200+ <a href="http://jinja.pocoo.org/">Jinja2</a> templates and turn on autoescape to reduce the likelihood of falling prey to an <a href="https://www.owasp.org/index.php/Cross-site_Scripting_(XSS)">XSS attack</a>. This gave us an excuse to audit all of our pages for injection holes: Here’s one hole <a href="http://jamie-wong.com/">Jamie Wong</a> pointed out that you might run into when using Ruby’s <code class="highlighter-rouge">.to_json</code> or Python’s <code class="highlighter-rouge">json.dumps</code>.</p> <p>Suppose you’re writing a web app and you want to pass down an untrusted string <code class="highlighter-rouge">username</code> from the server to your client-side JavaScript code. If you create a Rails template that looks like the following, are you safe from XSS attacks?</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;script&gt; Profile.init({ username: &lt;%=raw username.to_json %&gt; }); &lt;/script&gt; </code></pre></div></div> <p>(Here we use <code class="highlighter-rouge">raw</code> because we don’t want HTML entities in the JavaScript code.) Though we’re not exactly including unescaped HTML, there’s a subtle injection bug here that has to do with how browsers parse <code class="highlighter-rouge">&lt;script&gt;</code> tags.</p> <p>The <a href="http://www.w3.org/TR/html4/types.html#type-cdata">HTML spec</a> says:</p> <blockquote> <p>Markup and entities must be treated as raw text and passed to the application as is. The first occurrence of the character sequence “&lt;/” (end-tag open delimiter) is treated as terminating the end of the element’s content.</p> </blockquote> <p>Where’s the security hole? Consider if <code class="highlighter-rouge">username</code> was set to:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;/script&gt;&lt;script&gt;evil()&lt;/script&gt; </code></pre></div></div> <p>This will give us the following HTML:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;script&gt; Profile.init({ username: "&lt;/script&gt;&lt;script&gt;evil()&lt;/script&gt;" }); &lt;/script&gt; </code></pre></div></div> <p>Though the first <code class="highlighter-rouge">&lt;script&gt;</code> tag doesn’t contain valid JavaScript, it doesn’t matter – the second script tag will be read and so <code class="highlighter-rouge">evil()</code> will be executed.</p> <p>So what’s the fix? In addition to the common character escapes <code class="highlighter-rouge">\"</code>, <code class="highlighter-rouge">\\</code>, <code class="highlighter-rouge">\b</code>, <code class="highlighter-rouge">\f</code>, <code class="highlighter-rouge">\n</code>, <code class="highlighter-rouge">\r</code>, <code class="highlighter-rouge">\t</code>, and <code class="highlighter-rouge">\uXXXX</code>, the <a href="http://www.json.org/">JSON spec</a> states that <code class="highlighter-rouge">\/</code> will be interpreted as a literal slash. That is, in a JSON string literal, you can add a backslash before a slash character without otherwise changing the string. To prevent against this hole, you should replace every occurrence of <code class="highlighter-rouge">&lt;/</code> in your JSON with <code class="highlighter-rouge">&lt;\/</code> so that the <code class="highlighter-rouge">&lt;script&gt;</code> tag remains open. (The characters <code class="highlighter-rouge">&lt;</code> and <code class="highlighter-rouge">/</code> are valid only within a string literal so the replacement can’t affect anything else.)</p> <p>Regardless of which language you use, you’ll probably want to make a helper function to encapsulate this logic:</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Ruby</span> <span class="k">def</span> <span class="nf">jsonify</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="n">obj</span><span class="p">.</span><span class="nf">to_json</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="s1">'&lt;/'</span><span class="p">,</span> <span class="s1">'&lt;\/'</span><span class="p">)</span> <span class="k">end</span></code></pre></figure> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># Python </span><span class="k">def</span> <span class="nf">jsonify</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span> <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'&lt;/'</span><span class="p">,</span> <span class="s">'&lt;</span><span class="se">\\</span><span class="s">/'</span><span class="p">)</span></code></pre></figure> <p>As long as you always remember to use the <code class="highlighter-rouge">jsonify</code> wrapper instead of the built-in JSON serialization, you should be safe from this particular attack.</p> <hr /> <p><strong>Update (2018/03/10):</strong> Replacing <code class="highlighter-rouge">&lt;/</code> with <code class="highlighter-rouge">&lt;\/</code> works for JSON but isn’t necessarily correct when run over arbitrary JavaScript. Imagine the (nonsensical but valid) code <code class="highlighter-rouge">let x = foo &lt; /bar/;</code>. When minified, you’ll end up with <code class="highlighter-rouge">&lt;/</code> adjacent but since the <code class="highlighter-rouge">/</code> starts a regex, it isn’t correct to add a backslash.</p> <p>Instead, <a href="https://alf.nu/">Erling Ellingsen</a> and I concluded that escaping the “s” in script is a safe, general solution, since the same escaping (<code class="highlighter-rouge">\u0073</code>) is valid in all the places a letter can appear: strings, regexes, and JS identifiers. The following should work:</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Ruby</span> <span class="k">def</span> <span class="nf">scriptify</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="n">escaped</span> <span class="o">=</span> <span class="n">code</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="sr">/(?&lt;=&lt;\/)s(?=cript)/i</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">u%04x"</span> <span class="o">%</span> <span class="n">m</span><span class="p">.</span><span class="nf">ord</span> <span class="p">}</span> <span class="s2">"&lt;script&gt;</span><span class="si">#{</span><span class="n">escaped</span><span class="si">}</span><span class="s2">&lt;/script&gt;"</span> <span class="k">end</span></code></pre></figure> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># Python </span><span class="k">def</span> <span class="nf">scriptify</span><span class="p">(</span><span class="n">code</span><span class="p">):</span> <span class="n">escaped</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span> <span class="s">r'(?&lt;=&lt;/)s(?=cript)'</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">f</span><span class="s">'</span><span class="se">\\</span><span class="s">u{ord(m.group(0)):04x}'</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="k">return</span> <span class="n">f</span><span class="s">'&lt;script&gt;{escaped}&lt;/script&gt;'</span></code></pre></figure> </content>
</entry>
